# COSMOS Webservice

The COSMOS webservice 

## Running the service

To build the image and run it (from the root of the project), exposing port 8089:

```
[you@host ~/Cosmos]$ ./build.sh cosmos-service latest
[you@host ~/Cosmos]$  docker run -p 8089:8089 uwcosmos/cosmos-service:latest
```

Swagger documentation for the api can be found [online](http://xdd.wisc.edu/cosmos_service/docs), 
and will also be hosted at locally at http://localhost:8089/cosmos_service/docs while the service is running.

The 3 primary endpoints exposed by the API are as follows:

* [`POST /process`](https://xdd.wisc.edu/cosmos_service/docs#/default/process_document_cosmos_service_process__post) : Submit form data containing a single PDF for COSMOS processing. Begins processing in the background,
   and returns a job id that can be used to poll for progress.

* [`GET /process/{job_id}/status`](https://xdd.wisc.edu/cosmos_service/docs#/default/get_processing_status_cosmos_service_process__job_id__status_get) : Poll the process of the given processing job.

* [`GET /process/{job_id}/result`](https://xdd.wisc.edu/cosmos_service/docs#/default/get_processing_result_cosmos_service_process__job_id__result_get) : Get the results of a completed COSMOS extraction as a zip file.

Additional endpoints for retrieving specific result artifacts are documented via the swagger UI. 

## Example usage

An [IPython Notebook](https://github.com/UW-COSMOS/Cosmos/blob/master/notebooks/cosmos-service/cosmos_service.ipynb) demonstrating
basic interaction with the webservice can be found in the `notebooks/` directory of this repository. 

The API can also be interacted with via simple cURL requests as follows:
```bash
$ export URL=https://xdd.wisc.edu/cosmos_service
$ curl --form 'pdf=@"/path/to/sample.pdf"' "$URL/process/"
{
  "message": "PDF Processing in Background",
  "job_id": "{job_id}",
  "status_endpoint": "/process/{job_id}/status",
  "result_endpoint": "/process/{job_id}/result"
}

# Job still in progress
$ curl "$URL/process/{job_id}/status"
{
  "job_started": true,
  "job_completed": false,
  "time_in_queue": 3.884142,
  "time_processing": 20.014362,
  "error": null
}

# Job complete
$ curl "$URL/process/{job_id}/status"
{
  "job_started": true,
  "job_completed": true,
  "time_in_queue": 3.884142,
  "time_processing": 26.038767,
  "error": null
}


# Or, job failed
$ curl "$URL/process/{job_id}/status"
{
  "job_started": true,
  "job_completed": false,
  "time_in_queue": 3.884142,
  "time_processing": 26.038767,
  "error": "Something went wrong!"
}


# Retrieve results
$ curl -o output.zip "$URL/process/{job_id}/results"
```

## Tests

The `/test` directory contains a set of unit/integration tests for confirming COSMOS functionality against the running
webservice. Certain test parameters, such as the base URL against which tests are run, are configured via
[test/config.ini](https://github.com/UW-COSMOS/Cosmos/blob/master/cosmos_service/test/config.ini).

### Running Tests

Test prerequisites can be installed via `pip -r requirements.txt` from the `test` directory.
Once prerequisites are installed, tests can be run with the `pytest` command:

```bash
$ cd test
# install requirements
$ pip install -r requirements.txt
# run tests
$ pytest
```

### Test cases

Test cases for the COSMOS service are as follows:

#### Annotations

Annotations tests compare the bounding boxes and region labels generated by COSMOS against a 
series of manually annotated PDF documents. Each test compares one of the two following metrics:

* Count of labeled regions
* Area covered by bounding boxes

For the following 3 extraction labels:

* Equations
* Tables
* Figures

A separate test class is implemented per source document, with one metric/label pair per test. 
Tests currently fail if the metric fails for the given label class on any page of the source document.
Utility methods for writing tests against new source documents are included in `annotations/annotations_base.py`.
The source bounding boxes for a document should be generated as XML by the manual annotation tool and placed in the
`resources/annotations/<document name>` directory.
